<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>X 재게시 명단 분석기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body{font-family:'Inter',sans-serif;background-color:#121212}
  </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen p-4">
  <div class="bg-gray-900 rounded-xl shadow-2xl p-8 max-w-4xl w-full space-y-6 relative">
    <h1 class="text-3xl font-bold text-white text-center mb-6">X (트위터) 재게시 명단 분석기</h1>

    <!-- 입력 폼 -->
    <form id="crawler-form" class="flex flex-col sm:flex-row gap-4">
      <input id="url-input" type="url" required
        placeholder="게시글 URL (예: https://x.com/username/status/123...)"
        class="flex-grow p-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white"/>
      <button class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-600">크롤링 시작</button>
    </form>

    <div id="status-message" class="text-center text-gray-500 font-medium my-2 hidden"></div>

    <!-- 컨트롤 -->
    <div id="controls-section" class="space-y-4 hidden">
      <hr class="border-t border-gray-700">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="sort-by" class="text-gray-300 font-medium">정렬 기준:</label>
          <select id="sort-by" class="flex-grow p-2 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white">
            <option value="nickname">닉네임</option>
            <option value="following">팔로잉 상태</option>
            <option value="unfollowed">팔로우 안 함 상태</option>
          </select>
        </div>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="winner-count" class="text-gray-300 font-medium">추첨 인원:</label>
          <input id="winner-count" type="number" value="1" min="1" max="10"
                 class="w-20 p-2 border border-gray-600 rounded-lg text-center bg-gray-800 text-white">
          <button id="draw-button" type="button"
                  class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">추첨하기</button>
        </div>
      </div>
    </div>

    <!-- 결과 -->
    <div id="winners-section" class="space-y-4 hidden">
      <hr class="border-t border-gray-700">
      <h2 class="text-2xl font-bold text-gray-200">추첨 결과</h2>
      <div id="winners-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- 명단 -->
    <div id="retweet-list-section" class="space-y-4 hidden">
      <hr class="border-t border-gray-700">
      <h2 class="text-2xl font-bold text-gray-200">재게시 명단 (<span id="user-count">0</span>명)</h2>
      <div id="retweet-users" class="space-y-4 overflow-y-auto max-h-96"></div>
    </div>
  </div>

<script>
const form = document.getElementById('crawler-form');
const urlInput = document.getElementById('url-input');
const statusMessage = document.getElementById('status-message');
const controlsSection = document.getElementById('controls-section');
const sortBySelect = document.getElementById('sort-by');
const winnerCountInput = document.getElementById('winner-count');
const drawButton = document.getElementById('draw-button');
const winnersSection = document.getElementById('winners-section');
const winnersList = document.getElementById('winners-list');
const retweetListSection = document.getElementById('retweet-list-section');
const retweetUsersContainer = document.getElementById('retweet-users');
const userCountSpan = document.getElementById('user-count');

let users = []; // 서버에서 받아온 재게시 사용자 원본

function show(msg, cls='text-blue-400'){ statusMessage.textContent = msg; statusMessage.className = `text-center font-medium my-2 ${cls}`; statusMessage.classList.remove('hidden'); }
function hideStatus(){ statusMessage.classList.add('hidden'); }

function renderUsers(list){
  retweetUsersContainer.innerHTML='';
  if(!list.length){
    retweetUsersContainer.innerHTML = '<p class="text-center text-gray-400">재게시한 사용자가 없습니다.</p>';
  } else {
    list.forEach(u=>{
      const div=document.createElement('div');
      div.className='bg-gray-700 p-4 rounded-lg shadow-sm flex items-start space-x-4 border border-gray-600';
      div.innerHTML = `
        <div class="flex-grow">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-bold text-white">${u.nickname||'(no name)'}</span>
            <span class="text-sm text-gray-400">@${u.handle||''}</span>
          </div>
          <p class="text-sm text-gray-300 leading-snug">${u.description||''}</p>
        </div>
        <span class="whitespace-nowrap px-3 py-1 text-xs font-semibold rounded-full ${u.followStatus==='팔로잉' ? 'bg-blue-800 text-blue-100' : 'bg-gray-600 text-gray-300'}">
          ${u.followStatus||'팔로우'}
        </span>`;
      retweetUsersContainer.appendChild(div);
    });
  }
  userCountSpan.textContent = list.length;
}

function sortUsers(criterion){
  const list=[...users];
  if(criterion==='nickname') list.sort((a,b)=>(a.nickname||'').localeCompare(b.nickname||''));
  if(criterion==='following') list.sort((a,b)=> ((a.followStatus==='팔로잉')? -1:1) - ((b.followStatus==='팔로잉')? -1:1));
  if(criterion==='unfollowed') list.sort((a,b)=> ((a.followStatus==='팔로우')? -1:1) - ((b.followStatus==='팔로우')? -1:1));
  renderUsers(list);
}

async function callAPI(path, init){
  const res = await fetch(path, init);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const url=urlInput.value.trim();
  if(!url){ show('URL을 입력해주세요.','text-red-400'); return; }
  show('크롤링 중...');
  try{
    // 서버모드: 백엔드 API 호출
    const data = await callAPI(`/api/crawl?url=${encodeURIComponent(url)}`);
    users = data.users || [];
    renderUsers(users);
    controlsSection.classList.remove('hidden');
    retweetListSection.classList.remove('hidden');
    show('크롤링 완료!','text-green-400');
  }catch(err){
    // 정적모드(GitHub Actions 산출물) 폴백
    try{
      const data = await callAPI('data/retweeters.json');
      users = data.users || [];
      renderUsers(users);
      controlsSection.classList.remove('hidden');
      retweetListSection.classList.remove('hidden');
      show('API 실패: 저장된 데이터로 표시합니다.','text-orange-400');
    }catch(e2){
      show('크롤링/폴백 실패. 서버/데이터를 확인하세요.','text-red-400');
    }
  }
});

sortBySelect.addEventListener('change',(e)=>sortUsers(e.target.value));

drawButton.addEventListener('click', async ()=>{
  const n = parseInt(winnerCountInput.value||'1',10);
  if(!users.length){ alert('명단이 비어 있습니다.'); return; }
  if(n<1 || n>users.length){ alert('추첨 인원은 1 ~ 전체 인원수 사이여야 합니다.'); return; }
  winnersList.innerHTML='';
  winnersSection.classList.remove('hidden');
  try{
    const data = await callAPI('/api/draw', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({count:n, users})});
    (data.winners||[]).forEach(w=>{
      const d=document.createElement('div');
      d.className='bg-green-900 p-4 rounded-lg border-2 border-green-400';
      d.innerHTML=`<p class="font-bold text-lg text-green-300">${w.nickname}</p>
                   <p class="text-sm text-green-400">@${w.handle}</p>
                   <p class="text-xs text-green-500 mt-2 truncate">${w.description||''}</p>`;
      winnersList.appendChild(d);
    });
  }catch(err){
    // 폴백: 클라이언트에서 추첨
    const pool=[...users]; const set=new Set(); while(set.size<n){ set.add(pool.splice(Math.floor(Math.random()*pool.length),1)[0]); }
    Array.from(set).forEach(w=>{
      const d=document.createElement('div');
      d.className='bg-green-900 p-4 rounded-lg border-2 border-green-400';
      d.innerHTML=`<p class="font-bold text-lg text-green-300">${w.nickname}</p>
                   <p class="text-sm text-green-400">@${w.handle}</p>
                   <p class="text-xs text-green-500 mt-2 truncate">${w.description||''}</p>`;
      winnersList.appendChild(d);
    });
  }
});
</script>
</body>
</html>
